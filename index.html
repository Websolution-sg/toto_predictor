<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Singapore TOTO Predictor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font: 16px/1.5 Arial; padding: 20px; max-width: 600px; margin: auto; }
    select, button, input { font-size: 1em; margin: 0.5em 0; }
    canvas { max-width: 100%; }
  </style>
</head>
<body>
  <h1>Singapore TOTO Predictor</h1>
  <p id="recentResult">RECENT RESULT: Loading...</p>
  <div id="fetchStatus" style="font-size: 0.9em; color: #666; margin: 5px 0;"></div>
  <p>üìä By default, the previous lottery result is selected. 
     <a href="https://www.singaporepools.com.sg/en/product/Pages/toto_results.aspx" target="_blank" style="color: #007bff;">
       Check latest results on Singapore Pools ‚Üí
     </a>
  </p>
  <div>
    <select id="base1"></select>
    <select id="base2"></select>
    <select id="base3"></select>
    <select id="base4"></select>
    <select id="base5"></select>
    <select id="base6"></select>
  </div>
 
  <div>
    <label>Additional Number:</label><br/>
    <select id="additional"></select>
  </div>
  
  <div>
    <label>Select draw range:</label><br/>
    <select id="drawRange">
      <option value="20">Last 20</option>
      <option value="50">Last 50</option>
      <option value="100">Last 100</option>
    </select>
  </div>
  
  <label>
   <input type="checkbox" id="includeAdd"/> Include additional number

  </label><br/>

  <button onclick="predict()">Predict</button>
  <button onclick="fetchLatestTotoResults()" style="background-color: #28a745; color: white; margin-left: 10px;">Refresh Latest Results</button>
  <button onclick="manuallyUpdateResults()" style="background-color: #007bff; color: white; margin-left: 10px;">Manual Entry</button>

  <h2>Results</h2>
  <div id="results"></div>
  <canvas id="freqChart"></canvas>

<script>
let historical = [];

fetch('totoResult.csv')
  .then(response => {
    if (!response.ok) {
      throw new Error(`Failed to load CSV: ${response.status}`);
    }
    return response.text();
  })
  .then(text => {
    console.log('CSV loaded successfully');
    historical = text
      .trim()
      .split('\n')
      .map(line => line.split(',').map(Number));

    console.log('Historical data loaded:', historical.length, 'entries');

    // Populate selects
    for (let i = 1; i <= 49; i++) {
      ['base1', 'base2', 'base3', 'base4', 'base5', 'base6', 'additional'].forEach(id => {
        const opt = document.createElement('option');
        opt.value = opt.textContent = i;
        document.getElementById(id).append(opt);
      })
    }

    // Auto-select most recent result
    const recent = historical[0];
    ['base1', 'base2', 'base3', 'base4', 'base5', 'base6'].forEach((id, idx) => {
      document.getElementById(id).value = recent[idx];
    });
    document.getElementById('additional').value = recent[6];
    document.getElementById('includeAdd').checked = false;
    
    // Display the current recent result from CSV
    updateLatestResult(recent.slice(0, 6), recent[6]);
    
    // Automatically fetch latest TOTO results on page load
    fetchLatestTotoResults();
  })
  .catch(error => {
    console.error('Error loading CSV:', error);
    document.getElementById('recentResult').textContent = 'Error loading data: ' + error.message;
  });
    
    // Function to fetch latest TOTO results from Singapore Pools
    async function fetchLatestTotoResults() {
      const resultElement = document.getElementById('recentResult');
      const statusElement = document.getElementById('fetchStatus');
      const refreshButton = document.querySelector('button[onclick="fetchLatestTotoResults()"]');
      
      try {
        // Show loading state
        if (resultElement) {
          resultElement.textContent = 'RECENT RESULT: Fetching latest results...';
        }
        if (statusElement) {
          statusElement.textContent = 'üîÑ Attempting to fetch latest TOTO results...';
          statusElement.style.color = '#007bff';
        }
        if (refreshButton) {
          refreshButton.textContent = 'Fetching...';
          refreshButton.disabled = true;
        }
        
        console.log('Fetching latest TOTO results...');
        
        // First try to fetch directly from Singapore Pools
        if (statusElement) statusElement.textContent = 'üåê Trying Singapore Pools website...';
        let fetchedResults = await fetchFromSingaporePools();
        
        if (!fetchedResults) {
          // Fallback: Check if GitHub Action has updated the CSV
          if (statusElement) statusElement.textContent = 'üìÑ Checking CSV file for updates...';
          console.log('Direct fetch failed, checking CSV for updates...');
          fetchedResults = await checkCSVForUpdates();
        }
        
        if (fetchedResults) {
          const { winningNumbers, additionalNumber } = fetchedResults;
          
          // Check if this is newer than our current data
          const currentLatest = historical[0];
          const newResult = [...winningNumbers, additionalNumber];
          
          if (!arraysEqual(newResult, currentLatest)) {
            // Update historical data
            historical.unshift(newResult);
            
            // Update the page display
            updateLatestResult(winningNumbers, additionalNumber);
            
            // Auto-select the new result
            ['base1', 'base2', 'base3', 'base4', 'base5', 'base6'].forEach((id, idx) => {
              document.getElementById(id).value = winningNumbers[idx];
            });
            document.getElementById('additional').value = additionalNumber;
            
            console.log('Latest TOTO results updated successfully!');
            
            if (statusElement) {
              statusElement.textContent = '‚úÖ Successfully updated with latest results!';
              statusElement.style.color = '#28a745';
            }
            
            // Show success message briefly
            if (refreshButton && refreshButton.textContent === 'Fetching...') {
              refreshButton.textContent = 'Updated!';
              setTimeout(() => {
                refreshButton.textContent = 'Refresh Latest Results';
              }, 2000);
            }
          } else {
            console.log('Current data is already up to date.');
            if (statusElement) {
              statusElement.textContent = 'üìã Data is already up to date';
              statusElement.style.color = '#6c757d';
            }
            if (refreshButton && refreshButton.textContent === 'Fetching...') {
              refreshButton.textContent = 'Already Up to Date';
              setTimeout(() => {
                refreshButton.textContent = 'Refresh Latest Results';
              }, 2000);
            }
          }
        } else {
          // No new results found, restore original display
          const recent = historical[0];
          updateLatestResult(recent.slice(0, 6), recent[6]);
          
          if (statusElement) {
            statusElement.innerHTML = '‚ö†Ô∏è Could not fetch latest results. Using CSV data. <button onclick="manuallyUpdateResults()" style="background: #007bff; color: white; border: none; padding: 2px 8px; border-radius: 3px; font-size: 0.8em; margin-left: 5px;">Manual Entry</button>';
            statusElement.style.color = '#ffc107';
          }
        }
        
      } catch (error) {
        console.error('Error fetching TOTO results:', error);
        console.log('Using existing data from CSV file.');
        
        // Restore original display on error
        const recent = historical[0];
        updateLatestResult(recent.slice(0, 6), recent[6]);
        
        if (statusElement) {
          statusElement.innerHTML = '‚ùå Fetch failed. Using CSV data. <button onclick="manuallyUpdateResults()" style="background: #007bff; color: white; border: none; padding: 2px 8px; border-radius: 3px; font-size: 0.8em; margin-left: 5px;">Manual Entry</button>';
          statusElement.style.color = '#dc3545';
        }
      } finally {
        // Reset button state
        if (refreshButton) {
          refreshButton.disabled = false;
          if (refreshButton.textContent === 'Fetching...') {
            refreshButton.textContent = 'Refresh Latest Results';
          }
        }
        
        // Clear status after some time
        setTimeout(() => {
          if (statusElement && statusElement.style.color !== '#28a745') { // Don't clear success messages
            statusElement.textContent = '';
          }
        }, 10000);
      }
    }
    
    // Function to fetch directly from Singapore Pools
    async function fetchFromSingaporePools() {
      try {
        console.log('Attempting to fetch TOTO results...');
        
        // Method 1: Try using a CORS proxy to scrape Singapore Pools
        const corsProxies = [
          'https://api.allorigins.win/get?url=',
          'https://corsproxy.io/?',
          'https://api.codetabs.com/v1/proxy?quest='
        ];
        
        const targetUrl = 'https://www.singaporepools.com.sg/en/product/Pages/toto_results.aspx';
        
        for (const proxy of corsProxies) {
          try {
            console.log('Trying proxy:', proxy);
            
            // Create timeout controller
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            const response = await fetch(proxy + encodeURIComponent(targetUrl), {
              method: 'GET',
              headers: {
                'Accept': 'application/json, text/html',
              },
              signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (!response.ok) {
              console.log(`Proxy ${proxy} failed with status: ${response.status}`);
              continue;
            }
            
            let html;
            const contentType = response.headers.get('content-type');
            
            if (contentType && contentType.includes('application/json')) {
              const data = await response.json();
              html = data.contents || data.data || data;
            } else {
              html = await response.text();
            }
            
            // Parse the HTML for TOTO numbers
            const results = parseHTMLForTotoNumbers(html);
            if (results) {
              console.log('Successfully extracted TOTO numbers:', results);
              return results;
            }
            
          } catch (proxyError) {
            console.log(`Proxy ${proxy} error:`, proxyError.message);
            continue;
          }
        }
        
        // Method 2: Try alternative Singapore lottery data sources
        const alternativeAPIs = [
          'https://api.lottery.sg/toto/latest',
          'https://sg-lottery-api.herokuapp.com/toto/latest',
          'https://singapore-pools-api.vercel.app/api/toto'
        ];
        
        for (const apiUrl of alternativeAPIs) {
          try {
            console.log('Trying alternative API:', apiUrl);
            
            const response = await fetch(apiUrl, {
              method: 'GET',
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
              }
            });
            
            if (response.ok) {
              const data = await response.json();
              const results = extractTotoNumbers(data);
              if (results) {
                console.log('Successfully fetched from alternative API:', results);
                return results;
              }
            }
            
          } catch (apiError) {
            console.log(`Alternative API ${apiUrl} error:`, apiError.message);
            continue;
          }
        }
        
        // Method 3: Try to use a simple fallback with mock latest data
        console.log('All methods failed, checking for manual test data...');
        return await tryManualTestData();
        
      } catch (error) {
        console.log('All fetch methods failed:', error.message);
        return null;
      }
    }
    
    // Function to parse HTML for TOTO numbers
    function parseHTMLForTotoNumbers(html) {
      try {
        // Create a temporary DOM element to parse HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        
        // Try different selectors that might contain TOTO results
        const selectors = [
          '.drawResults .number',
          '.winning-numbers',
          '.result-number',
          '.toto-number',
          'span[class*="ball"]',
          'div[class*="number"]',
          '.latest-result',
          'table tr td'
        ];
        
        for (const selector of selectors) {
          const elements = tempDiv.querySelectorAll(selector);
          if (elements.length >= 7) {
            const numbers = Array.from(elements)
              .slice(0, 7)
              .map(el => parseInt(el.textContent.trim()))
              .filter(n => !isNaN(n) && n >= 1 && n <= 49);
            
            if (numbers.length >= 7) {
              console.log('Found numbers with selector:', selector, numbers);
              return {
                winningNumbers: numbers.slice(0, 6),
                additionalNumber: numbers[6]
              };
            }
          }
        }
        
        // Fallback: Look for number patterns in the entire HTML
        const numberMatches = html.match(/\b([1-9]|[1-4][0-9])\b/g);
        if (numberMatches && numberMatches.length >= 7) {
          // Filter and validate numbers
          const validNumbers = numberMatches
            .map(n => parseInt(n))
            .filter(n => n >= 1 && n <= 49);
          
          if (validNumbers.length >= 7) {
            // Look for the most recent/relevant set of 7 numbers
            // This is a heuristic approach
            const potentialResults = [];
            for (let i = 0; i <= validNumbers.length - 7; i++) {
              const subset = validNumbers.slice(i, i + 7);
              // Check if these could be valid TOTO numbers (no duplicates)
              if (new Set(subset).size === 7) {
                potentialResults.push(subset);
              }
            }
            
            if (potentialResults.length > 0) {
              const numbers = potentialResults[0]; // Take the first valid set
              console.log('Found number pattern:', numbers);
              return {
                winningNumbers: numbers.slice(0, 6),
                additionalNumber: numbers[6]
              };
            }
          }
        }
        
        return null;
      } catch (error) {
        console.log('HTML parsing failed:', error);
        return null;
      }
    }
    
    // Function to extract TOTO numbers from API response
    function extractTotoNumbers(data) {
      try {
        let winningNumbers, additionalNumber;
        
        // Try different response formats
        if (data.results && data.results[0]) {
          const result = data.results[0];
          winningNumbers = result.winningNumbers || result.numbers || result.draw;
          additionalNumber = result.additionalNumber || result.additional || result.bonus;
        } else if (data.winningNumbers || data.numbers) {
          winningNumbers = data.winningNumbers || data.numbers;
          additionalNumber = data.additionalNumber || data.additional || data.bonus;
        } else if (data.draw) {
          winningNumbers = data.draw.slice(0, 6);
          additionalNumber = data.draw[6];
        } else if (Array.isArray(data) && data.length >= 7) {
          winningNumbers = data.slice(0, 6);
          additionalNumber = data[6];
        }
        
        // Validate the numbers
        if (winningNumbers && Array.isArray(winningNumbers) && winningNumbers.length === 6 && 
            additionalNumber && !isNaN(additionalNumber)) {
          
          const validNumbers = winningNumbers.every(n => !isNaN(n) && n >= 1 && n <= 49);
          const validAdditional = additionalNumber >= 1 && additionalNumber <= 49;
          
          if (validNumbers && validAdditional) {
            return { winningNumbers: winningNumbers.map(n => parseInt(n)), additionalNumber: parseInt(additionalNumber) };
          }
        }
        
        return null;
      } catch (error) {
        console.log('Number extraction failed:', error);
        return null;
      }
    }
    
    // Function to try manual test data or prompt user
    async function tryManualTestData() {
      try {
        // Check if we're in a development/test environment
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          console.log('Development mode detected, using test data');
          // Use some recent test data
          return {
            winningNumbers: [5, 12, 18, 25, 31, 42],
            additionalNumber: 7
          };
        }
        
        // For production, we could prompt the user or check a backup source
        console.log('Production mode: No automatic test data');
        return null;
        
      } catch (error) {
        console.log('Test data generation failed:', error);
        return null;
      }
    }
    
    // Function to check CSV for updates (fallback)
    async function checkCSVForUpdates() {
      try {
        const response = await fetch('totoResult.csv?' + Date.now()); // Cache busting
        const text = await response.text();
        const newHistorical = text
          .trim()
          .split('\n')
          .map(line => line.split(',').map(Number));
        
        // Check if we have new data
        const currentLatest = historical[0];
        const fetchedLatest = newHistorical[0];
        
        if (!arraysEqual(fetchedLatest, currentLatest)) {
          // Update historical data
          historical = newHistorical;
          
          return {
            winningNumbers: fetchedLatest.slice(0, 6),
            additionalNumber: fetchedLatest[6]
          };
        }
        
        return null;
      } catch (error) {
        console.log('CSV check failed:', error);
        return null;
      }
    }
    
    // Function to update the display of latest results
    function updateLatestResult(winningNumbers, additionalNumber) {
      const resultText = `${winningNumbers.join(',')}(${additionalNumber})`;
      const resultElement = document.getElementById('recentResult');
      if (resultElement) {
        resultElement.textContent = `RECENT RESULT: ${resultText}`;
      }
    }
    
    let chartInstance = null;

    function predict() {
      const hasHistoricalMatch = checkHistoricalAndMaybePredict();
      if (!hasHistoricalMatch) {
        runFrequencyCompatibilityPrediction();
      }
    }

function checkHistoricalAndMaybePredict() {
  const bases = getSelectedBases().sort((a, b) => a - b);
  const mostRecentDraw = historical[0].slice(0, 6).sort((a, b) => a - b);

  // ‚úÖ Skip historical prediction entirely if base = most recent draw
  if (arraysEqual(bases, mostRecentDraw)) {
    return false;
  }

  for (let i = historical.length - 1; i > 0; i--) {
    const draw = historical[i].slice(0, 6).sort((a, b) => a - b);

    // This only prevents matching the most recent draw as a historical case
    if (arraysEqual(draw, mostRecentDraw)) {
      continue;
    }

    if (arraysEqual(draw, bases)) {
      const prevDraw = historical[i - 1];
      calculateScoresAndDisplay(prevDraw.slice(0, 6), prevDraw[6]);
      return true;
    }
  }

  return false;
}

    function getSelectedBases() {
      return ['base1', 'base2', 'base3', 'base4', 'base5', 'base6']
        .map(id => parseInt(document.getElementById(id).value))
        .sort((a, b) => a - b);
    }

    function arraysEqual(a, b) {
      return a.length === b.length && a.every((val, index) => val === b[index]);
    }

    function calculateScoresAndDisplay(numbers, additional = null) {
      const bases = numbers.slice();
      const range = parseInt(document.getElementById('drawRange').value);
      const includeAdd = document.getElementById('includeAdd').checked;
      const draws = historical.slice(0, range);
      const freq = Array(50).fill(0);
      const compat = Array(50).fill(0);

      draws.forEach(draw => {
        const pool = includeAdd ? draw.slice(0, 6).concat(draw[6]) : draw.slice(0, 6);
        pool.forEach(n => freq[n]++);
        bases.forEach(b => {
          if (pool.includes(b)) {
            pool.filter(n => n !== b).forEach(n => compat[n]++);
          }
        });
      });

      const scores = numbers.map(n => freq[n] + compat[n]);
      console.log('Sanity Check - Predicted Numbers:');
      numbers.forEach((n, i) => {
        console.log(`Number ${n} -> Frequency: ${freq[n]}, Compatibility: ${compat[n]}, Total Score: ${scores[i]}`);
      });
      displayPredictedNumbers(numbers, additional, scores, freq, compat);
    }

    function runFrequencyCompatibilityPrediction() {
      const bases = getSelectedBases();
      const range = parseInt(document.getElementById('drawRange').value);
      const includeAdd = document.getElementById('includeAdd').checked;
      const draws = historical.slice(0, range);
      const freq = Array(50).fill(0);
      const compat = Array(50).fill(0);

      draws.forEach(draw => {
        const pool = includeAdd ? draw.slice(0, 6).concat(draw[6]) : draw.slice(0, 6);
        pool.forEach(n => freq[n]++);
        bases.forEach(b => {
          if (pool.includes(b)) {
            pool.filter(n => n !== b).forEach(n => compat[n]++);
          }
        });
      });

      const suggestions = freq
        .map((count, n) => ({ n, count, compat: compat[n] }))
        .filter(o => o.n)
        .sort((a, b) => (b.compat + b.count) - (a.compat + a.count) || b.count - a.count || a.n - b.n)
        .slice(0, 6);

      const scores = suggestions.map(o => o.count + o.compat);
      console.log('Sanity Check - Suggestions:');
      suggestions.forEach((o, i) => {
        console.log(`Number ${o.n} -> Frequency: ${o.count}, Compatibility: ${o.compat}, Total Score: ${scores[i]}`);
      });
      displayPredictedNumbers(suggestions.map(o => o.n), null, scores, freq, compat);
    }

    function displayPredictedNumbers(numbers, additional = null, scores, freq, compat) {
      const rs = document.getElementById('results');
      // Sort numbers, scores, freq, compat for both display and chart
     const sorted = numbers
     .map((n, i) => ({
      n,
      score: scores[i],
      freq: freq[n],
      compat: compat[n]
  }))
  .sort((a, b) => a.n - b.n);  // ‚úÖ ASCENDING ORDER by number
      const sortedNumbers = sorted.map(o => o.n);
      const sortedScores = sorted.map(o => o.score);
      const sortedFreq = sorted.map(o => o.freq);
      const sortedCompat = sorted.map(o => o.compat);
      rs.innerHTML = '<h3>Predicted Numbers:</h3>' +
        `<p>${sortedNumbers.join(', ')}</p>`;

      const ctx = document.getElementById('freqChart').getContext('2d');
      if (chartInstance) {
        chartInstance.destroy();
      }
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sortedNumbers.map((n, i) => `${n}\n(freq: ${sortedFreq[i]}, compat: ${sortedCompat[i]})`),
          datasets: [{
            label: 'Total Score',
            data: sortedScores,
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const index = context.dataIndex;
                  return `Freq: ${sortedFreq[index]}, Compat: ${sortedCompat[index]}, Total: ${sortedScores[index]}`;
                }
              }
            }
          },
          scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
      });
    }
    
    // Function to manually update TOTO results
    function manuallyUpdateResults() {
      // Create and show the manual entry modal
      const modal = document.createElement('div');
      modal.id = 'manualEntryModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      `;
      
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: white;
        padding: 20px;
        border-radius: 10px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        text-align: center;
      `;
      
      modalContent.innerHTML = `
        <h3 style="color: #007bff; margin-bottom: 20px;">Manual TOTO Results Entry</h3>
        <p style="margin-bottom: 20px; color: #666;">Enter the latest TOTO winning numbers:</p>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
          <div>
            <label style="display: block; font-size: 0.9em; color: #555;">Ball 1:</label>
            <input type="number" id="manual1" min="1" max="49" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
          </div>
          <div>
            <label style="display: block; font-size: 0.9em; color: #555;">Ball 2:</label>
            <input type="number" id="manual2" min="1" max="49" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
          </div>
          <div>
            <label style="display: block; font-size: 0.9em; color: #555;">Ball 3:</label>
            <input type="number" id="manual3" min="1" max="49" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
          </div>
          <div>
            <label style="display: block; font-size: 0.9em; color: #555;">Ball 4:</label>
            <input type="number" id="manual4" min="1" max="49" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
          </div>
          <div>
            <label style="display: block; font-size: 0.9em; color: #555;">Ball 5:</label>
            <input type="number" id="manual5" min="1" max="49" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
          </div>
          <div>
            <label style="display: block; font-size: 0.9em; color: #555;">Ball 6:</label>
            <input type="number" id="manual6" min="1" max="49" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
          </div>
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-size: 0.9em; color: #555; margin-bottom: 5px;">Additional Number:</label>
          <input type="number" id="manualAdditional" min="1" max="49" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
        </div>
        
        <div id="manualValidationError" style="color: #dc3545; margin-bottom: 15px; font-size: 0.9em; display: none;"></div>
        
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button onclick="submitManualEntry()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
            ‚úÖ Update Results
          </button>
          <button onclick="closeManualEntryModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
            ‚ùå Cancel
          </button>
        </div>
        
        <p style="margin-top: 15px; font-size: 0.8em; color: #888;">
          üí° Tip: You can find the latest results at 
          <a href="https://www.singaporepools.com.sg/en/product/Pages/toto_results.aspx" target="_blank" style="color: #007bff;">Singapore Pools</a>
        </p>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      // Focus on first input
      setTimeout(() => {
        document.getElementById('manual1').focus();
      }, 100);
      
      // Allow closing modal by clicking outside
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeManualEntryModal();
        }
      });
    }
    
    // Function to submit manual entry
    function submitManualEntry() {
      const errorDiv = document.getElementById('manualValidationError');
      errorDiv.style.display = 'none';
      
      try {
        // Collect all the numbers
        const winningNumbers = [];
        for (let i = 1; i <= 6; i++) {
          const value = parseInt(document.getElementById(`manual${i}`).value);
          if (isNaN(value) || value < 1 || value > 49) {
            throw new Error(`Ball ${i} must be a number between 1 and 49`);
          }
          winningNumbers.push(value);
        }
        
        const additionalNumber = parseInt(document.getElementById('manualAdditional').value);
        if (isNaN(additionalNumber) || additionalNumber < 1 || additionalNumber > 49) {
          throw new Error('Additional number must be between 1 and 49');
        }
        
        // Check for duplicates
        const allNumbers = [...winningNumbers, additionalNumber];
        const uniqueNumbers = new Set(allNumbers);
        if (uniqueNumbers.size !== allNumbers.length) {
          throw new Error('All numbers must be unique (no duplicates allowed)');
        }
        
        // Sort winning numbers for consistency
        winningNumbers.sort((a, b) => a - b);
        
        // Update the application
        const newResult = [...winningNumbers, additionalNumber];
        
        // Add to historical data at the beginning
        historical.unshift(newResult);
        
        // Update the display
        updateLatestResult(winningNumbers, additionalNumber);
        
        // Auto-select the new result
        ['base1', 'base2', 'base3', 'base4', 'base5', 'base6'].forEach((id, idx) => {
          document.getElementById(id).value = winningNumbers[idx];
        });
        document.getElementById('additional').value = additionalNumber;
        
        // Update status
        const statusElement = document.getElementById('fetchStatus');
        if (statusElement) {
          statusElement.textContent = '‚úÖ Results updated manually!';
          statusElement.style.color = '#28a745';
        }
        
        // Close modal
        closeManualEntryModal();
        
        console.log('Manual TOTO results updated successfully!', { winningNumbers, additionalNumber });
        
      } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
      }
    }
    
    // Function to close manual entry modal
    function closeManualEntryModal() {
      const modal = document.getElementById('manualEntryModal');
      if (modal) {
        modal.remove();
      }
    }
  </script>
</body>
</html>