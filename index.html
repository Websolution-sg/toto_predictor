<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Singapore TOTO Predictor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font: 16px/1.5 Arial; padding: 20px; max-width: 600px; margin: auto; }
    select, button, input { font-size: 1em; margin: 0.5em 0; }
    canvas { max-width: 100%; }
  </style>
</head>
<body>
  <h1>Singapore TOTO Predictor</h1>
  <p id="recentResult">RECENT RESULT: Loading...</p>
  <p>By default, the previous lottery result is selected:</p>
  <div>
    <select id="base1"></select>
    <select id="base2"></select>
    <select id="base3"></select>
    <select id="base4"></select>
    <select id="base5"></select>
    <select id="base6"></select>
  </div>
 
  <div>
    <label>Additional Number:</label><br/>
    <select id="additional"></select>
  </div>

  <div>
    <label>Select draw range:</label><br/>
    <select id="drawRange">
      <option value="20">Last 20</option>
      <option value="50">Last 50</option>
      <option value="100">Last 100</option>
    </select>
  </div>

  <label>
    <input type="checkbox" id="includeAdd"/> Include additional number
  </label><br/>

  <button onclick="predict()">Predict</button>

  <h2>Results</h2>
  <div id="results"></div>
  <canvas id="freqChart"></canvas>

<script>
let historical = [];

function downloadCSV() {
  const csvContent = historical.map(row => row.join(",")).join("\n");
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.setAttribute("href", url);
  link.setAttribute("download", "totoResult_updated.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

fetch('totoResult.csv')
  .then(response => response.text())
  .then(text => {
    historical = text.trim().split('\n').map(line => line.split(',').map(Number));

    for (let i = 1; i <= 49; i++) {
      ['base1', 'base2', 'base3', 'base4', 'base5', 'base6', 'additional'].forEach(id => {
        const opt = document.createElement('option');
        opt.value = opt.textContent = i;
        document.getElementById(id).append(opt);
      });
    }

    const recent = historical[0];
    ['base1', 'base2', 'base3', 'base4', 'base5', 'base6'].forEach((id, idx) => {
      document.getElementById(id).value = recent[idx];
    });
    document.getElementById('additional').value = recent[6];
    document.getElementById('includeAdd').checked = false;

    updateLatestResult(recent.slice(0, 6), recent[6]);

    fetchLatestTotoResults();
  });

async function fetchLatestTotoResults() {
  const resultElement = document.getElementById('recentResult');

  try {
    if (resultElement) resultElement.textContent = 'RECENT RESULT: Fetching latest results...';

    const response = await fetch('https://www.singaporepools.com.sg/en/product/Pages/toto_results.aspx');
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

    const text = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'text/html');

    const drawDateElement = doc.querySelector('.table-responsive .table tbody tr:first-child td:first-child');
    const numbersElement = doc.querySelector('.table-responsive .table tbody tr:first-child td:nth-child(2)');
    const additionalElement = doc.querySelector('.table-responsive .table tbody tr:first-child td:nth-child(3)');

    if (!drawDateElement || !numbersElement || !additionalElement) throw new Error('Could not find draw information');

    const winningNumbers = numbersElement.textContent.trim().split(' ').map(n => parseInt(n.trim())).filter(n => !isNaN(n)).sort((a, b) => a - b);
    const additionalNumber = parseInt(additionalElement.textContent.trim());

    const currentLatest = historical[0];
    const newResult = [...winningNumbers, additionalNumber];

    if (!arraysEqual(newResult, currentLatest)) {
      updateLatestResult(winningNumbers, additionalNumber);
      historical.unshift(newResult);
      ['base1', 'base2', 'base3', 'base4', 'base5', 'base6'].forEach((id, idx) => {
        document.getElementById(id).value = winningNumbers[idx];
      });
      document.getElementById('additional').value = additionalNumber;

      // Save to CSV
      downloadCSV();
    }
  } catch (error) {
    console.log('Error fetching latest TOTO results:', error);
  }
}
</script>
</body>
</html>
